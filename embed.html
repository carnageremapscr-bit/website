<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carnage Remaps Vehicle Search</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
    }
    .widget {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 1.5rem;
      color: #fff;
      max-width: 100%;
    }
    .header {
      text-align: center;
      margin-bottom: 1rem;
    }
    .logo {
      max-width: 150px;
      height: auto;
      margin-bottom: 0.5rem;
    }
    .header h2 {
      margin: 0 0 0.25rem;
      font-size: 1.25rem;
      color: #fff;
    }
    .header p {
      color: #94a3b8;
      margin: 0;
      font-size: 0.8rem;
    }
    .form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 500px) {
      .form { grid-template-columns: 1fr; }
    }
    select {
      padding: 0.6rem;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      color: #fff;
      font-size: 0.9rem;
      width: 100%;
      cursor: pointer;
    }
    select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    option {
      background: #1a1a1a;
      color: #fff;
    }
    .buttons {
      display: flex;
      gap: 0.5rem;
    }
    button {
      padding: 0.6rem 1rem;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      font-size: 0.9rem;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .secondary { background: rgba(255,255,255,0.1); }
    .info {
      color: #94a3b8;
      font-size: 0.7rem;
      text-align: center;
      margin-top: 0.5rem;
    }
    
    /* Results Section */
    .results {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .results.show { display: block; }
    .results h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: #fff;
    }
    .vehicle-info {
      background: rgba(255,255,255,0.05);
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    .stages {
      display: grid;
      gap: 0.75rem;
    }
    .stage {
      background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(59,130,246,0.1));
      border: 1px solid rgba(139,92,246,0.3);
      border-radius: 8px;
      padding: 0.75rem;
    }
    .stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .stage-name {
      font-weight: 600;
      color: #a78bfa;
      font-size: 0.9rem;
    }
    .stage-power {
      color: #22c55e;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .stage-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      font-size: 0.8rem;
    }
    .detail-item {
      display: flex;
      justify-content: space-between;
    }
    .detail-label { color: #94a3b8; }
    .detail-value { color: #fff; font-weight: 500; }
    .back-btn {
      margin-top: 1rem;
      background: rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <div class="widget">
    <!-- Search Form -->
    <div id="searchSection">
      <div class="header">
        <img src="/assets/media/logo.avif" alt="Carnage Remaps" class="logo" onerror="this.style.display='none'">
        <h2>Vehicle Performance Search</h2>
        <p>Find ECU tuning options for your vehicle</p>
      </div>
      
      <div class="form">
        <select id="mfr"><option value="">Loading...</option></select>
        <select id="mdl" disabled><option value="">Select Model</option></select>
        <select id="yr" disabled><option value="">Select Year</option></select>
        <select id="eng" disabled><option value="">Select Engine</option></select>
      </div>
      
      <div class="buttons">
        <button type="button" id="searchBtn" disabled>üîç Search</button>
        <button type="button" class="secondary" id="portalBtn">Full Portal ‚Üí</button>
      </div>
      
      <p class="info">Powered by Carnage Remaps</p>
    </div>
    
    <!-- Results Section -->
    <div id="resultsSection" class="results">
      <h3>üèéÔ∏è Tuning Options Available</h3>
      <div class="vehicle-info" id="vehicleInfo"></div>
      <div class="stages" id="stagesContainer"></div>
      <button type="button" class="back-btn" id="backBtn">‚Üê Back to Search</button>
    </div>
  </div>

  <script>
    (function() {
      var portalUrl = 'https://web-production-df12d.up.railway.app';
      var D = { models: {}, engines: {}, genericEngines: [] };
      
      var mfr = document.getElementById('mfr');
      var mdl = document.getElementById('mdl');
      var yr = document.getElementById('yr');
      var eng = document.getElementById('eng');
      var searchBtn = document.getElementById('searchBtn');
      var portalBtn = document.getElementById('portalBtn');
      var backBtn = document.getElementById('backBtn');
      var searchSection = document.getElementById('searchSection');
      var resultsSection = document.getElementById('resultsSection');
      var vehicleInfo = document.getElementById('vehicleInfo');
      var stagesContainer = document.getElementById('stagesContainer');

      // Tuning data (Stage gains)
      var TUNING_DATA = {
        'diesel': {
          'stage1': { powerGain: '20-30%', torqueGain: '25-35%', method: 'ECU Remap' },
          'stage2': { powerGain: '30-45%', torqueGain: '35-50%', method: 'Remap + Hardware' },
          'stage3': { powerGain: '45-60%', torqueGain: '50-70%', method: 'Full Build' }
        },
        'petrol': {
          'stage1': { powerGain: '15-25%', torqueGain: '15-25%', method: 'ECU Remap' },
          'stage2': { powerGain: '25-40%', torqueGain: '25-40%', method: 'Remap + Intake/Exhaust' },
          'stage3': { powerGain: '40-60%', torqueGain: '40-55%', method: 'Full Build' }
        }
      };

      // Get URL parameters for customization
      var params = new URLSearchParams(window.location.search);
      var color = params.get('color') || '#dc2626';
      var bg = params.get('bg') || '#1a1a1a';
      
      document.querySelector('.widget').style.background = bg;
      searchBtn.style.background = color;
      document.querySelectorAll('.stage-name').forEach(function(el) {
        el.style.color = color;
      });

      // Fetch vehicle data
      fetch('/api/vehicles')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          D = data;
          mfr.innerHTML = '<option value="">Select Manufacturer</option>';
          Object.keys(data.models).sort().forEach(function(k) {
            var opt = document.createElement('option');
            opt.value = k;
            opt.textContent = k.split('-').map(function(w) {
              return w.charAt(0).toUpperCase() + w.slice(1);
            }).join(' ');
            mfr.appendChild(opt);
          });
        })
        .catch(function() {
          mfr.innerHTML = '<option value="">Error loading</option>';
        });

      function checkFields() {
        searchBtn.disabled = !(mfr.value && mdl.value && yr.value && eng.value);
      }

      mfr.onchange = function() {
        mdl.disabled = !mfr.value;
        mdl.innerHTML = '<option value="">Select Model</option>';
        yr.disabled = true;
        yr.innerHTML = '<option value="">Select Year</option>';
        eng.disabled = true;
        eng.innerHTML = '<option value="">Select Engine</option>';
        
        if (mfr.value && D.models && D.models[mfr.value]) {
          D.models[mfr.value].forEach(function(m) {
            var opt = document.createElement('option');
            opt.value = m.toLowerCase().replace(/\s+/g, '-');
            opt.textContent = m;
            mdl.appendChild(opt);
          });
        }
        checkFields();
      };

      mdl.onchange = function() {
        yr.disabled = !mdl.value;
        yr.innerHTML = '<option value="">Select Year</option>';
        eng.disabled = true;
        eng.innerHTML = '<option value="">Select Engine</option>';
        
        if (mdl.value) {
          for (var y = 2024; y >= 2000; y--) {
            var opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yr.appendChild(opt);
          }
        }
        checkFields();
      };

      yr.onchange = function() {
        eng.disabled = !yr.value;
        eng.innerHTML = '<option value="">Select Engine</option>';
        
        if (yr.value) {
          var engines = (D.engines && D.engines[mfr.value]) ? D.engines[mfr.value] : D.genericEngines;
          if (engines) {
            engines.forEach(function(e) {
              var opt = document.createElement('option');
              opt.value = e;
              opt.textContent = e;
              eng.appendChild(opt);
            });
          }
        }
        checkFields();
      };

      eng.onchange = checkFields;

      // Show results instead of redirect
      searchBtn.onclick = function() {
        if (mfr.value && mdl.value && yr.value && eng.value) {
          showResults();
        }
      };

      function showResults() {
        var mfrName = mfr.options[mfr.selectedIndex].textContent;
        var mdlName = mdl.options[mdl.selectedIndex].textContent;
        var engineText = eng.value;
        
        // Determine if diesel or petrol
        var isDiesel = engineText.toLowerCase().includes('tdi') || 
                       engineText.toLowerCase().includes('cdi') || 
                       engineText.toLowerCase().includes('hdi') ||
                       engineText.toLowerCase().includes('dci') ||
                       engineText.toLowerCase().includes('jtd') ||
                       engineText.toLowerCase().includes('d-4d') ||
                       engineText.toLowerCase().includes('crdi') ||
                       engineText.toLowerCase().includes('diesel') ||
                       engineText.toLowerCase().includes('bluehdi') ||
                       engineText.toLowerCase().includes('skyactiv-d');
        
        var fuelType = isDiesel ? 'diesel' : 'petrol';
        var tuning = TUNING_DATA[fuelType];
        
        // Parse original power
        var powerMatch = engineText.match(/(\d+)\s*hp/i);
        var originalPower = powerMatch ? parseInt(powerMatch[1]) : 150;
        
        // Show vehicle info
        vehicleInfo.innerHTML = '<strong>' + yr.value + ' ' + mfrName + ' ' + mdlName + '</strong><br>' +
          '<span style="color:#94a3b8">' + engineText + '</span>';
        
        // Build stage cards
        var stagesHTML = '';
        
        // Stage 1
        var s1Min = Math.round(originalPower * 1.15);
        var s1Max = Math.round(originalPower * (isDiesel ? 1.30 : 1.25));
        stagesHTML += buildStageCard('Stage 1', s1Min + '-' + s1Max + ' HP', 
          '+' + tuning.stage1.powerGain + ' Power', '+' + tuning.stage1.torqueGain + ' Torque', tuning.stage1.method);
        
        // Stage 2
        var s2Min = Math.round(originalPower * 1.25);
        var s2Max = Math.round(originalPower * (isDiesel ? 1.45 : 1.40));
        stagesHTML += buildStageCard('Stage 2', s2Min + '-' + s2Max + ' HP',
          '+' + tuning.stage2.powerGain + ' Power', '+' + tuning.stage2.torqueGain + ' Torque', tuning.stage2.method);
        
        // Stage 3
        var s3Min = Math.round(originalPower * 1.40);
        var s3Max = Math.round(originalPower * (isDiesel ? 1.60 : 1.55));
        stagesHTML += buildStageCard('Stage 3', s3Min + '-' + s3Max + ' HP',
          '+' + tuning.stage3.powerGain + ' Power', '+' + tuning.stage3.torqueGain + ' Torque', tuning.stage3.method);
        
        stagesContainer.innerHTML = stagesHTML;
        
        // Toggle sections
        searchSection.style.display = 'none';
        resultsSection.classList.add('show');
      }
      
      function buildStageCard(name, power, powerGain, torqueGain, method) {
        return '<div class="stage">' +
          '<div class="stage-header">' +
            '<span class="stage-name">' + name + '</span>' +
            '<span class="stage-power">' + power + '</span>' +
          '</div>' +
          '<div class="stage-details">' +
            '<div class="detail-item"><span class="detail-label">Power:</span><span class="detail-value">' + powerGain + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Torque:</span><span class="detail-value">' + torqueGain + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Method:</span><span class="detail-value">' + method + '</span></div>' +
          '</div>' +
        '</div>';
      }

      backBtn.onclick = function() {
        searchSection.style.display = 'block';
        resultsSection.classList.remove('show');
      };

      portalBtn.onclick = function() {
        window.open(portalUrl, '_blank');
      };
    })();
  </script>
</body>
</html>
