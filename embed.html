<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <base target="_self">
  <title>Carnage Remaps Vehicle Search v3</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      width: 100%;
      min-height: 100%;
    }
    /* Hide scrollbars but allow scroll */
    html { overflow-y: auto; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    * { -ms-overflow-style: none; scrollbar-width: none; }
    
    .widget {
      background: var(--bg, #1a1a1a);
      border-radius: 16px;
      padding: 1.25rem;
      color: #fff;
      width: 100%;
    }
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .logo {
      max-width: 160px;
      height: auto;
      margin-bottom: 0.75rem;
    }
    .header h2 {
      margin: 0 0 0.5rem;
      font-size: 1.5rem;
      color: #fff;
    }
    .header p {
      color: #94a3b8;
      margin: 0;
      font-size: 1rem;
    }
    .form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 500px) {
      .form { grid-template-columns: 1fr; gap: 0.75rem; }
    }
    select {
      padding: 1rem;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      width: 100%;
      cursor: pointer;
      min-height: 52px;
      /* Keep native appearance on mobile for proper dropdown behavior */
      -webkit-appearance: menulist;
      -moz-appearance: menulist;
      appearance: menulist;
    }
    select:disabled { opacity: 0.5; cursor: not-allowed; }
    option { background: #1a1a1a; color: #fff; }
    .btn-row { display: flex; gap: 0.75rem; }
    button {
      padding: 1rem 1.5rem;
      background: var(--accent, #dc2626);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      flex: 1;
      font-size: 1.1rem;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 56px;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .info { color: #94a3b8; font-size: 0.85rem; text-align: center; margin-top: 1rem; }

    /* Results */
    .results { display: none; overflow-y: auto; overflow-x: hidden; }
    .results.show { display: block; }
    .vehicle-title {
      background: linear-gradient(135deg, #8b5cf6, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
    }
    .engine-badge {
      background: rgba(139,92,246,0.2);
      border: 1px solid rgba(139,92,246,0.4);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    .stage-card {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .stage-name { font-weight: 700; color: #22c55e; font-size: 1.1rem; }
    .stage-method { font-size: 0.9rem; color: #94a3b8; }
    .perf-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    .perf-box {
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 0.75rem;
      text-align: center;
    }
    .perf-label { font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.3rem; }
    .perf-row { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
    .stock { color: #94a3b8; }
    .arrow { color: #22c55e; }
    .tuned { color: #22c55e; font-weight: 700; }
    .gain { color: #22c55e; font-size: 0.9rem; margin-top: 0.25rem; }
    .back-btn { margin-top: 1rem; background: rgba(255,255,255,0.1); }
    
    /* Quote buttons section */
    .quote-section {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
      text-align: center;
    }
    .quote-title {
      color: white;
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .quote-subtitle {
      color: rgba(255,255,255,0.9);
      font-size: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .quote-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .quote-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      color: white;
      flex: 1;
      min-width: 80px;
      max-width: 120px;
      justify-content: center;
      text-decoration: none;
    }
    .quote-btn.whatsapp { background: #25D366; }
    .quote-btn.email { background: #EA4335; }
    .quote-btn.sms { background: #0088cc; }
    .quote-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div class="widget" id="widget">
    <!-- SEARCH FORM -->
    <div id="searchForm">
      <div class="header">
        <img src="https://web-production-df12d.up.railway.app/assets/media/logo.avif" alt="Carnage Remaps" class="logo" onerror="this.style.display='none'">
        <h2>Vehicle Performance Search</h2>
        <p>Find ECU tuning options for your vehicle</p>
      </div>
      <div class="form">
        <select id="mfr"><option value="">Select Manufacturer</option></select>
        <select id="mdl" disabled><option value="">Select Model</option></select>
        <select id="yr" disabled><option value="">Select Year Range</option></select>
        <select id="eng" disabled><option value="">Select Engine</option></select>
      </div>
      <div class="btn-row">
        <button id="searchBtn" disabled>üîç Search</button>
      </div>
      <p class="info">Powered by Carnage Remaps</p>
    </div>

    <!-- RESULTS -->
    <div id="resultsView" class="results">
      <div class="vehicle-title" id="vehicleTitle"></div>
      <div class="engine-badge" id="engineBadge"></div>
      <div id="stagesContainer"></div>
      
      <!-- Quote Buttons -->
      <div class="quote-section" id="quoteSection">
        <div class="quote-title">üéØ Get a Quote</div>
        <div class="quote-subtitle">Contact us for pricing</div>
        <div class="quote-buttons">
          <a href="#" id="whatsappBtn" class="quote-btn whatsapp" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            WhatsApp
          </a>
          <a href="#" id="emailBtn" class="quote-btn email" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            Email
          </a>
          <a href="#" id="smsBtn" class="quote-btn sms" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            SMS
          </a>
        </div>
      </div>
      
      <button class="back-btn" id="backBtn">‚Üê New Search</button>
    </div>
  </div>

  <script>
    (function() {
      var API = 'https://web-production-df12d.up.railway.app';
      
      // Get URL params for customization
      var params = new URLSearchParams(window.location.search);
      var accentColor = params.get('color') || '#dc2626';
      var bgColor = params.get('bg') || '#1a1a1a';
      var customTitle = params.get('title');
      var customDesc = params.get('desc');
      var showYear = params.get('showYear');
      var showPerf = params.get('showPerf');
      var showStages = params.get('showStages');
      var logoParam = params.get('logo');
      var waParam = params.get('wa');
      var emailParam = params.get('email');

      var widget = document.getElementById('widget');
      widget.style.setProperty('--accent', accentColor);
      widget.style.setProperty('--bg', bgColor);

      // Apply custom title/description if provided
      var headerTitle = document.querySelector('.header h2');
      var headerDesc = document.querySelector('.header p');
      if (customTitle && headerTitle) headerTitle.textContent = customTitle;
      if (customDesc && headerDesc) headerDesc.textContent = customDesc;

      // Apply logo override if provided
      if (logoParam) {
        var logoImg = document.querySelector('.logo');
        if (logoImg) {
          logoImg.src = logoParam;
          // keep existing onerror behaviour
          logoImg.style.display = 'block';
        }
      }

      // Show/hide year dropdown
      var yearDropdown = document.getElementById('yr');
      if (yearDropdown && showYear !== null) {
        yearDropdown.style.display = showYear === '1' ? 'inline-block' : 'none';
      }

      // Show/hide performance badges (quote section)
      var quoteSection = document.getElementById('quoteSection');
      if (quoteSection && showPerf !== null) {
        quoteSection.style.display = showPerf === '1' ? 'block' : 'none';
      }

      // Apply contact overrides (WhatsApp / email) if provided
      var whatsappBtn = document.getElementById('whatsappBtn');
      var emailBtn = document.getElementById('emailBtn');
      var smsBtn = document.getElementById('smsBtn');
      function normalizePhone(p) {
        if (!p) return '';
        var phone = p.replace(/[^0-9+]/g, '');
        if (phone.startsWith('+')) phone = phone.slice(1);
        // convert leading 0 to 44 (UK) as best-effort
        if (phone.length >= 10 && phone[0] === '0') phone = '44' + phone.slice(1);
        return phone;
      }
      var normalized = normalizePhone(waParam);
      if (whatsappBtn) {
        // leave link for quote message populated later; if we have a phone override, use it in base
        whatsappBtn.dataset.override = normalized || '';
      }
      if (emailBtn) {
        emailBtn.dataset.override = emailParam || '';
      }
      if (smsBtn) {
        smsBtn.dataset.override = normalized || '';
      }

      // Show/hide all stage cards (handled after results are rendered)
      var _showStages = showStages;

      var mfr = document.getElementById('mfr');
      var mdl = document.getElementById('mdl');
      var yr = document.getElementById('yr');
      var eng = document.getElementById('eng');
      var searchBtn = document.getElementById('searchBtn');
      var backBtn = document.getElementById('backBtn');
      var searchForm = document.getElementById('searchForm');
      var resultsView = document.getElementById('resultsView');

      // Vehicle database (will be populated from API)
      var DB = { models: {}, engines: {}, yearData: {}, yearEngines: {} };

      // Year ranges for models (fallback)
      var YEAR_RANGES = ['2021-2024', '2017-2020', '2013-2016', '2009-2012', '2005-2008', '2000-2004'];

      // Load data from API with cache-busting
      fetch(API + '/api/vehicles?v=' + Date.now(), {
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          DB.models = data.models;
          DB.engines = data.engines;
          DB.genericEngines = data.genericEngines;
          DB.yearEngines = data.yearEngines || {};
          populateManufacturers();
        })
        .catch(function(err) {
          console.error('Failed to load vehicle data:', err);
          mfr.innerHTML = '<option value="">Error loading data</option>';
        });

      function populateManufacturers() {
        mfr.innerHTML = '<option value="">Select Manufacturer</option>';
        Object.keys(DB.models).sort().forEach(function(key) {
          var opt = document.createElement('option');
          opt.value = key;
          opt.textContent = formatName(key);
          mfr.appendChild(opt);
        });
      }

      function formatName(str) {
        return str.split('-').map(function(w) {
          return w.charAt(0).toUpperCase() + w.slice(1);
        }).join(' ');
      }

      function checkReady() {
        searchBtn.disabled = !(mfr.value && mdl.value && yr.value && eng.value);
      }

      mfr.onchange = function() {
        mdl.innerHTML = '<option value="">Select Model</option>';
        yr.innerHTML = '<option value="">Select Year Range</option>';
        eng.innerHTML = '<option value="">Select Engine</option>';
        mdl.disabled = !mfr.value;
        yr.disabled = true;
        eng.disabled = true;

        if (mfr.value && DB.models[mfr.value]) {
          DB.models[mfr.value].forEach(function(m) {
            var opt = document.createElement('option');
            opt.value = m.toLowerCase().replace(/\s+/g, '-');
            opt.textContent = m;
            mdl.appendChild(opt);
          });
        }
        checkReady();
      };

      mdl.onchange = function() {
        yr.innerHTML = '<option value="">Select Year Range</option>';
        eng.innerHTML = '<option value="">Select Engine</option>';
        yr.disabled = !mdl.value;
        eng.disabled = true;

        if (mdl.value) {
          // Try to get year-specific data from yearEngines
          var mfrKey = mfr.value;
          var mdlKey = mdl.value;
          var yearData = DB.yearEngines[mfrKey] && DB.yearEngines[mfrKey][mdlKey];
          
          if (yearData) {
            // Use year ranges from the detailed database
            Object.keys(yearData).forEach(function(range) {
              var opt = document.createElement('option');
              opt.value = range;
              opt.textContent = range;
              yr.appendChild(opt);
            });
          } else {
            // Fall back to standard year ranges
            YEAR_RANGES.forEach(function(range) {
              var opt = document.createElement('option');
              opt.value = range;
              opt.textContent = range;
              yr.appendChild(opt);
            });
          }
        }
        checkReady();
      };

      yr.onchange = function() {
        eng.innerHTML = '<option value="">Select Engine</option>';
        eng.disabled = !yr.value;

        if (yr.value) {
          var mfrKey = mfr.value;
          var mdlKey = mdl.value;
          var yearData = DB.yearEngines[mfrKey] && DB.yearEngines[mfrKey][mdlKey];
          var engines = null;
          
          // Try year-specific engines first
          if (yearData && yearData[yr.value]) {
            engines = yearData[yr.value];
          }
          
          // Fall back to manufacturer engines, then generic
          if (!engines || engines.length === 0) {
            engines = DB.engines[mfrKey] || DB.genericEngines;
          }
          
          engines.forEach(function(e) {
            var opt = document.createElement('option');
            opt.value = e;
            opt.textContent = e;
            eng.appendChild(opt);
          });
        }
        checkReady();
      };

      eng.onchange = checkReady;

      searchBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!mfr.value || !mdl.value || !yr.value || !eng.value) return;
        showResults();
      };

      backBtn.onclick = function() {
        searchForm.style.display = 'block';
        resultsView.classList.remove('show');
      };

      function showResults() {
        var mfrName = mfr.options[mfr.selectedIndex].textContent;
        var mdlName = mdl.options[mdl.selectedIndex].textContent;
        var yearRange = yr.value;
        var engineStr = eng.value;

        // Parse engine info
        var hpMatch = engineStr.match(/(\d+)\s*hp/i);
        var stockHP = hpMatch ? parseInt(hpMatch[1]) : 150;
        
        // Determine if diesel
        var isDiesel = /tdi|cdi|hdi|dci|jtd|d-4d|crdi|bluehdi|skyactiv-d|diesel|multijet/i.test(engineStr);
        var fuelType = isDiesel ? 'Diesel' : 'Petrol';

        // Calculate stage power (diesel gets more gains)
        var s1Power = Math.round(stockHP * (isDiesel ? 1.25 : 1.20));
        var s2Power = Math.round(stockHP * (isDiesel ? 1.40 : 1.35));
        var s3Power = Math.round(stockHP * (isDiesel ? 1.55 : 1.50));

        // Estimate torque (diesel ~2x, petrol ~1.5x of HP)
        var stockTorque = Math.round(stockHP * (isDiesel ? 2.2 : 1.1));
        var s1Torque = Math.round(stockTorque * (isDiesel ? 1.30 : 1.20));
        var s2Torque = Math.round(stockTorque * (isDiesel ? 1.45 : 1.35));
        var s3Torque = Math.round(stockTorque * (isDiesel ? 1.60 : 1.50));

        // Update title
        document.getElementById('vehicleTitle').textContent = mfrName + ' ' + mdlName + ' (' + yearRange + ')';
        document.getElementById('engineBadge').innerHTML = 
          '<strong>' + engineStr + '</strong> ‚Ä¢ ' + fuelType + ' ‚Ä¢ Turbocharged';

        // Build stages
        var html = '';
        
        // Stage 1
        html += buildStageCard('Stage 1', 'ECU Remap Only', stockHP, s1Power, stockTorque, s1Torque);
        
        // Stage 2
        html += buildStageCard('Stage 2', 'Remap + Intake/Exhaust', stockHP, s2Power, stockTorque, s2Torque);
        
        // Stage 3
        html += buildStageCard('Stage 3', 'Full Build + Hybrid Turbo', stockHP, s3Power, stockTorque, s3Torque);

        document.getElementById('stagesContainer').innerHTML = html;
        // Hide all stage cards if showStages param is 0
        if (_showStages === '0') {
          var stageCards = document.querySelectorAll('.stage-card');
          stageCards.forEach(function(card) {
            card.style.display = 'none';
          });
        }

        // Set up quote buttons
        var quoteMsg = encodeURIComponent(
          'Hi! I\'m interested in ECU tuning for my ' + mfrName + ' ' + mdlName + 
          ' (' + yearRange + ') with ' + engineStr + '. Can you provide a quote?'
        );
        
        // Use overrides passed via data attributes (from URL params) if present
        var waBtn = document.getElementById('whatsappBtn');
        var emBtn = document.getElementById('emailBtn');
        var sBtn = document.getElementById('smsBtn');
        var waOverride = waBtn?.dataset?.override || '';
        var emailOverride = emBtn?.dataset?.override || '';
        var defaultPhone = '447546371963';
        var defaultEmail = 'carnageremaps@gmail.com';

        var targetPhone = waOverride || defaultPhone;
        // whatsapp link
        if (waBtn) waBtn.href = 'https://wa.me/' + targetPhone + '?text=' + quoteMsg;
        // email link
        if (emBtn) emBtn.href = 'mailto:' + (emailOverride || defaultEmail) + '?subject=' + encodeURIComponent('Quote Request: ' + mfrName + ' ' + mdlName) + '&body=' + quoteMsg;
        // sms link (ensure leading + when using sms: on some platforms)
        if (sBtn) sBtn.href = 'sms:+' + (targetPhone) + '?body=' + quoteMsg;

        // Toggle views
        searchForm.style.display = 'none';
        resultsView.classList.add('show');
      }

      function buildStageCard(name, method, stockHP, tunedHP, stockTq, tunedTq) {
        var hpGain = tunedHP - stockHP;
        var tqGain = tunedTq - stockTq;
        
        return '<div class="stage-card">' +
          '<div class="stage-header">' +
            '<span class="stage-name">' + name + '</span>' +
            '<span class="stage-method">' + method + '</span>' +
          '</div>' +
          '<div class="perf-grid">' +
            '<div class="perf-box">' +
              '<div class="perf-label">POWER</div>' +
              '<div class="perf-row">' +
                '<span class="stock">' + stockHP + '</span>' +
                '<span class="arrow">‚Üí</span>' +
                '<span class="tuned">' + tunedHP + ' HP</span>' +
              '</div>' +
              '<div class="gain">+' + hpGain + ' HP (+' + Math.round(hpGain/stockHP*100) + '%)</div>' +
            '</div>' +
            '<div class="perf-box">' +
              '<div class="perf-label">TORQUE</div>' +
              '<div class="perf-row">' +
                '<span class="stock">' + stockTq + '</span>' +
                '<span class="arrow">‚Üí</span>' +
                '<span class="tuned">' + tunedTq + ' Nm</span>' +
              '</div>' +
              '<div class="gain">+' + tqGain + ' Nm (+' + Math.round(tqGain/stockTq*100) + '%)</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }
    })();
  </script>
</body>
</html>
