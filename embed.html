<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YGHMFR684T"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YGHMFR684T');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <base target="_self">
  <title>Carnage Remaps Vehicle Search v3</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --accent: #dc2626;
      --accent-2: #b91c1c;
      --bg: #1a1a1a;
      --text: #ffffff;
      --muted: #94a3b8;
      --card: rgba(0,0,0,0.2);
      --stage1: #22c55e;
      --stage2: #f59e0b;
      --stage3: #ef4444;
    }
    html {
      --accent: inherit;
      --accent-2: inherit;
      --bg: inherit;
      --text: inherit;
      --muted: inherit;
      --card: inherit;
      --stage1: inherit;
      --stage2: inherit;
      --stage3: inherit;
    }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      width: 100%;
      min-height: 100%;
    }
    /* Hide scrollbars but allow scroll */
    html { overflow-y: auto; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    * { -ms-overflow-style: none; scrollbar-width: none; }
    
    .widget {
      background: var(--bg, #1a1a1a);
      border-radius: 16px;
      padding: 1.25rem;
      color: var(--text, #fff);
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .logo {
      max-width: 160px;
      height: auto;
      margin-bottom: 0.75rem;
    }
    .header h2 {
      margin: 0 0 0.5rem;
      font-size: 1.5rem;
      color: var(--text, #fff);
      word-break: break-word;
    }
    .header p {
      color: var(--muted, #94a3b8);
      margin: 0;
      font-size: 1rem;
      word-break: break-word;
    }
    .form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) {
      .widget {
        padding: 1rem;
        border-radius: 12px;
      }
      .header {
        margin-bottom: 1rem;
      }
      .header h2 {
        font-size: 1.2rem;
      }
      .header p {
        font-size: 0.9rem;
      }
      .logo {
        max-width: 120px;
      }
      .form {
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
    }
    @media (max-width: 500px) {
      .widget {
        padding: 0.875rem;
        border-radius: 10px;
      }
      .form { 
        grid-template-columns: 1fr; 
        gap: 0.75rem; 
        margin-bottom: 0.875rem;
      }
      .header {
        margin-bottom: 0.75rem;
      }
      .header h2 {
        font-size: 1rem;
      }
      .header p {
        font-size: 0.8rem;
      }
      .logo {
        max-width: 100px;
        margin-bottom: 0.5rem;
      }
    }
    select {
      padding: 1rem;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      width: 100%;
      cursor: pointer;
      min-height: 52px;
      /* Keep native appearance on mobile for proper dropdown behavior */
      -webkit-appearance: menulist;
      -moz-appearance: menulist;
      appearance: menulist;
    }
    select:disabled { opacity: 0.5; cursor: not-allowed; }
    option { background: #1a1a1a; color: #fff; }
    .btn-row { 
      display: flex; 
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    button {
      padding: 1rem 1.5rem;
      background: var(--accent, #dc2626);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      flex: 1;
      font-size: 1.1rem;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 56px;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    @media (max-width: 768px) {
      select {
        padding: 0.875rem;
        font-size: 16px;
        min-height: 48px;
      }
      button {
        padding: 0.875rem 1.25rem;
        font-size: 1rem;
        min-height: 48px;
      }
      .btn-row {
        gap: 0.625rem;
      }
    }
    @media (max-width: 500px) {
      select {
        padding: 0.75rem;
        font-size: 16px;
        min-height: 44px;
      }
      button {
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        min-height: 44px;
      }
      .btn-row {
        flex-direction: column;
        gap: 0.5rem;
      }
      .btn-row button {
        width: 100%;
      }
    }
    .info { color: var(--muted, #94a3b8); font-size: 0.85rem; text-align: center; margin-top: 1rem; }

    /* Results */
    .results { display: none; overflow-y: auto; overflow-x: hidden; }
    .results.show { display: block; }
    .vehicle-title {
      background: linear-gradient(135deg, var(--accent, #dc2626), var(--accent-2, #b91c1c));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      word-break: break-word;
    }
    .engine-badge {
      background: color-mix(in srgb, var(--accent, #dc2626) 20%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent, #dc2626) 40%, transparent);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      overflow: hidden;
      word-break: break-word;
    }
    .stage-card {
      background: linear-gradient(135deg, color-mix(in srgb, var(--stage1, #22c55e) 15%, transparent), color-mix(in srgb, var(--stage1, #22c55e) 5%, transparent));
      border: 1px solid color-mix(in srgb, var(--stage1, #22c55e) 30%, transparent);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .stage-name { font-weight: 700; color: var(--stage1, #22c55e); font-size: 1.1rem; }
    .stage-method { font-size: 0.9rem; color: var(--muted, #94a3b8); }
    .perf-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    .perf-box {
      background: var(--card, rgba(0,0,0,0.2));
      border-radius: 6px;
      padding: 0.75rem;
      text-align: center;
    }
    .perf-label { font-size: 0.8rem; color: var(--muted, #94a3b8); margin-bottom: 0.3rem; word-break: break-word; }
    .perf-row { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
    .stock { color: var(--muted, #94a3b8); }
    .arrow { color: var(--stage1, #22c55e); }
    .tuned { color: var(--stage1, #22c55e); font-weight: 700; }
    .gain { color: var(--stage1, #22c55e); font-size: 0.9rem; margin-top: 0.25rem; }
    .back-btn { margin-top: 1rem; background: rgba(255,255,255,0.1); }
    
    @media (max-width: 768px) {
      .vehicle-title {
        font-size: 1.1rem;
      }
      .engine-badge {
        padding: 0.625rem;
        font-size: 0.9rem;
      }
      .stage-card {
        padding: 0.875rem;
        margin-bottom: 0.625rem;
      }
      .stage-name {
        font-size: 1rem;
      }
      .stage-method {
        font-size: 0.8rem;
      }
      .perf-box {
        padding: 0.625rem;
      }
      .perf-label {
        font-size: 0.75rem;
      }
      .perf-row {
        font-size: 0.95rem;
      }
    }
    @media (max-width: 500px) {
      .vehicle-title {
        font-size: 1rem;
      }
      .engine-badge {
        padding: 0.5rem;
        font-size: 0.85rem;
        margin-bottom: 0.75rem;
      }
      .stage-card {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .stage-header {
        gap: 0.25rem;
      }
      .stage-name {
        font-size: 0.95rem;
      }
      .stage-method {
        font-size: 0.75rem;
      }
      .perf-grid {
        gap: 0.5rem;
      }
      .perf-box {
        padding: 0.5rem;
      }
      .perf-label {
        font-size: 0.65rem;
        margin-bottom: 0.2rem;
      }
      .perf-row {
        font-size: 0.85rem;
      }
      .gain {
        font-size: 0.75rem;
      }
    }
    
    /* Quote buttons section */
    .quote-section {
      background: linear-gradient(90deg, #84cc16 0%, #eab308 25%, #f97316 50%, #ef4444 75%, #dc2626 100%);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
      text-align: center;
    }
    .quote-title { color: var(--text, #fff); font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; }
    .quote-subtitle {
      color: color-mix(in srgb, var(--text, #fff) 90%, transparent);
      font-size: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .quote-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .quote-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      color: white;
      flex: 1;
      min-width: 80px;
      max-width: 120px;
      justify-content: center;
      text-decoration: none;
    }
    .quote-btn.whatsapp { background: #25D366; }
    .quote-btn.email { background: #EA4335; }
    .quote-btn.sms { background: #0088cc; }
    .quote-btn:hover { opacity: 0.9; }
    
    @media (max-width: 768px) {
      .quote-section {
        padding: 0.875rem;
        margin-top: 0.875rem;
        border-radius: 8px;
      }
      .quote-title {
        font-size: 0.95rem;
      }
      .quote-subtitle {
        font-size: 0.7rem;
      }
      .quote-buttons {
        gap: 0.375rem;
      }
      .quote-btn {
        padding: 0.5rem 0.625rem;
        font-size: 0.7rem;
        min-width: 70px;
        max-width: 100px;
      }
    }
    @media (max-width: 500px) {
      .quote-section {
        padding: 0.75rem;
        margin-top: 0.75rem;
        border-radius: 8px;
      }
      .quote-title {
        font-size: 0.9rem;
        margin-bottom: 0.375rem;
      }
      .quote-subtitle {
        font-size: 0.65rem;
        margin-bottom: 0.625rem;
      }
      .quote-buttons {
        gap: 0.25rem;
        flex-direction: column;
      }
      .quote-btn {
        padding: 0.5rem 0.625rem;
        font-size: 0.65rem;
        min-width: unset;
        max-width: unset;
        width: 100%;
      }
    }

    #iframe-locked,
    #subscription-check {
      display: none !important;
    }

    #iframe-locked.show,
    #subscription-check.show {
      display: flex !important;
    }
  </style>
</head>
<body>
  <!-- Subscription Check Overlay -->
  <div id="subscription-check" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:10000;font-family:inherit">
    <div style="background:#1a1a1a;border:1px solid #444;border-radius:12px;padding:40px;text-align:center;max-width:400px;color:#fff">
      <div style="font-size:3rem;margin-bottom:1rem">üîí</div>
      <h2 style="margin-bottom:1rem;font-size:1.5rem">Subscription Required</h2>
      <p style="color:#999;margin-bottom:1.5rem;line-height:1.6">This embedded widget requires an active Embed Widget subscription (¬£9.99/month)</p>
      <p style="color:#666;font-size:0.9rem">Please contact the website owner to enable access.</p>
    </div>
  </div>

  <!-- Iframe Locked Overlay -->
  <div id="iframe-locked" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:10000;font-family:inherit">
    <div style="background:#1a1a1a;border:1px solid #ef4444;border-radius:12px;padding:40px;text-align:center;max-width:420px;color:#fff">
      <div style="font-size:3rem;margin-bottom:1rem">‚è∏Ô∏è</div>
      <h2 style="margin-bottom:1rem;font-size:1.5rem">Widget Locked</h2>
      <p style="color:#fca5a5;margin-bottom:1.25rem;line-height:1.6">This embed has been locked by an admin.</p>
      <p style="color:#94a3b8;font-size:0.9rem">Please contact the site owner to restore access.</p>
    </div>
  </div>

  <div class="widget" id="widget">
    <!-- SEARCH FORM -->
    <div id="searchForm">
      <div class="header">
        <img src="https://web-production-df12d.up.railway.app/assets/media/logo.avif" alt="Carnage Remaps" class="logo" onerror="this.style.display='none'">
        <h2>Vehicle Performance Search</h2>
        <p>Find ECU tuning options for your vehicle</p>
      </div>
      <div class="form">
        <select id="mfr"><option value="">Select Manufacturer</option></select>
        <select id="mdl" disabled><option value="">Select Model</option></select>
        <select id="yr" disabled><option value="">Select Year Range</option></select>
        <select id="eng" disabled><option value="">Select Engine</option></select>
      </div>
      <div class="btn-row">
        <button id="searchBtn" disabled>üîç Search</button>
      </div>
      <p class="info">Powered by Carnage Remaps</p>
    </div>

    <!-- RESULTS -->
    <div id="resultsView" class="results">
      <div class="vehicle-title" id="vehicleTitle"></div>
      <div class="engine-badge" id="engineBadge"></div>
      <div id="stagesContainer"></div>
      
      <!-- Quote Buttons -->
      <div class="quote-section" id="quoteSection">
        <div class="quote-title">üéØ Get a Quote</div>
        <div class="quote-subtitle">Contact us for pricing</div>
        <div class="quote-buttons">
          <a href="#" id="whatsappBtn" class="quote-btn whatsapp" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            WhatsApp
          </a>
          <a href="#" id="emailBtn" class="quote-btn email" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            Email
          </a>
          <a href="#" id="smsBtn" class="quote-btn sms" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            SMS
          </a>
        </div>
      </div>
      
      <button class="back-btn" id="backBtn">‚Üê New Search</button>
    </div>
  </div>

  <script>
    (function() {
      var API = 'https://web-production-df12d.up.railway.app';
      
      // Get URL params for customization
      var params = new URLSearchParams(window.location.search);
      var accentColor = params.get('color') || '#dc2626';
      var accentColor2 = params.get('color2') || '#b91c1c';
      var bgColor = params.get('bg') || '#1a1a1a';
      var textColor = params.get('text') || '#ffffff';
      var mutedColor = params.get('muted') || '#94a3b8';
      var cardColor = params.get('card') || 'rgba(0,0,0,0.2)';
      var stage1Color = params.get('stage1') || accentColor;
      var stage2Color = params.get('stage2') || '#f59e0b';
      var stage3Color = params.get('stage3') || '#ef4444';
      var customTitle = params.get('title');
      var customDesc = params.get('desc');
      var showYear = params.get('showYear');
      var showPerf = params.get('showPerf');
      var showStages = params.get('showStages');
      var logoParam = params.get('logo');
      var waParam = params.get('wa');
      var emailParam = params.get('email');

      var widget = document.getElementById('widget');
      var htmlEl = document.documentElement;
      htmlEl.style.setProperty('--accent', accentColor);
      htmlEl.style.setProperty('--accent-2', accentColor2);
      htmlEl.style.setProperty('--bg', bgColor);
      htmlEl.style.setProperty('--text', textColor);
      htmlEl.style.setProperty('--muted', mutedColor);
      htmlEl.style.setProperty('--card', cardColor);
      htmlEl.style.setProperty('--stage1', stage1Color);
      htmlEl.style.setProperty('--stage2', stage2Color);
      htmlEl.style.setProperty('--stage3', stage3Color);

      // Apply custom title/description if provided
      var headerTitle = document.querySelector('.header h2');
      var headerDesc = document.querySelector('.header p');
      if (customTitle && headerTitle) headerTitle.textContent = customTitle;
      if (customDesc && headerDesc) headerDesc.textContent = customDesc;

      // Apply logo override if provided
      if (logoParam) {
        var logoImg = document.querySelector('.logo');
        if (logoImg) {
          logoImg.src = logoParam;
          // keep existing onerror behaviour
          logoImg.style.display = 'block';
        }
      }

      // Show/hide year dropdown
      var yearDropdown = document.getElementById('yr');
      if (yearDropdown && showYear !== null) {
        yearDropdown.style.display = showYear === '1' ? 'inline-block' : 'none';
      }

      // Show/hide performance badges (quote section)
      var quoteSection = document.getElementById('quoteSection');
      if (quoteSection && showPerf !== null) {
        quoteSection.style.display = showPerf === '1' ? 'block' : 'none';
      }

      // Apply contact overrides (WhatsApp / email) if provided
      var whatsappBtn = document.getElementById('whatsappBtn');
      var emailBtn = document.getElementById('emailBtn');
      var smsBtn = document.getElementById('smsBtn');
      function normalizePhone(p) {
        if (!p) return '';
        var phone = p.replace(/[^0-9+]/g, '');
        if (phone.startsWith('+')) phone = phone.slice(1);
        // convert leading 0 to 44 (UK) as best-effort
        if (phone.length >= 10 && phone[0] === '0') phone = '44' + phone.slice(1);
        return phone;
      }
      var normalized = normalizePhone(waParam);
      if (whatsappBtn) {
        // leave link for quote message populated later; if we have a phone override, use it in base
        whatsappBtn.dataset.override = normalized || '';
      }
      if (emailBtn) {
        emailBtn.dataset.override = emailParam || '';
      }
      if (smsBtn) {
        smsBtn.dataset.override = normalized || '';
      }

      // Show/hide all stage cards (handled after results are rendered)
      var _showStages = showStages;

      var mfr = document.getElementById('mfr');
      var mdl = document.getElementById('mdl');
      var yr = document.getElementById('yr');
      var eng = document.getElementById('eng');
      var searchBtn = document.getElementById('searchBtn');
      var backBtn = document.getElementById('backBtn');
      var searchForm = document.getElementById('searchForm');
      var resultsView = document.getElementById('resultsView');

      // Vehicle database (will be populated from API)
      var DB = { models: {}, engines: {}, yearData: {}, yearEngines: {} };

      // Year ranges for models (fallback)
      var YEAR_RANGES = ['2021-2026', '2017-2020', '2013-2016', '2009-2012', '2005-2008', '2000-2004'];

      function normalizeModelKey(model) {
        return (model || '')
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');
      }

      function findModelInYearDatabase(mfrKey, modelKey) {
        if (!mfrKey || !modelKey || !DB.yearEngines[mfrKey]) return null;
        if (DB.yearEngines[mfrKey][modelKey]) return modelKey;

        var normalizedInput = normalizeModelKey(modelKey);
        var keys = Object.keys(DB.yearEngines[mfrKey]);

        for (var i = 0; i < keys.length; i++) {
          if (normalizeModelKey(keys[i]) === normalizedInput) {
            return keys[i];
          }
        }

        return null;
      }

      // Load data from API with cache-busting
      fetch(API + '/api/vehicles?v=' + Date.now(), {
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          DB.models = data.models || {};
          DB.yearEngines = data.yearEngines || {};
          populateManufacturers();
        })
        .catch(function(err) {
          console.error('Failed to load vehicle data:', err);
          mfr.innerHTML = '<option value="">Error loading data</option>';
        });

      function populateManufacturers() {
        mfr.innerHTML = '<option value="">Select Manufacturer</option>';
        Object.keys(DB.models).sort().forEach(function(key) {
          var opt = document.createElement('option');
          opt.value = key;
          opt.textContent = formatName(key);
          mfr.appendChild(opt);
        });
      }

      function formatName(str) {
        return str.split('-').map(function(w) {
          return w.charAt(0).toUpperCase() + w.slice(1);
        }).join(' ');
      }

      function checkReady() {
        searchBtn.disabled = !(mfr.value && mdl.value && yr.value && eng.value);
      }

      mfr.onchange = function() {
        mdl.innerHTML = '<option value="">Select Model</option>';
        yr.innerHTML = '<option value="">Select Year Range</option>';
        eng.innerHTML = '<option value="">Select Engine</option>';
        delete mdl.dataset.actualKey;
        mdl.disabled = !mfr.value;
        yr.disabled = true;
        eng.disabled = true;

        if (mfr.value && DB.models[mfr.value]) {
          DB.models[mfr.value].forEach(function(m) {
            var opt = document.createElement('option');
            opt.value = m.toLowerCase().replace(/\s+/g, '-');
            opt.textContent = m;
            mdl.appendChild(opt);
          });
        }
        checkReady();
      };

      mdl.onchange = function() {
        yr.innerHTML = '<option value="">Select Year Range</option>';
        eng.innerHTML = '<option value="">Select Engine</option>';
        yr.disabled = !mdl.value;
        eng.disabled = true;
        delete mdl.dataset.actualKey;

        if (mdl.value) {
          // Try to get year-specific data from yearEngines
          var mfrKey = mfr.value;
          var rawModelKey = mdl.value;
          var actualModelKey = findModelInYearDatabase(mfrKey, rawModelKey);
          var yearData = actualModelKey && DB.yearEngines[mfrKey] && DB.yearEngines[mfrKey][actualModelKey];

          if (actualModelKey) {
            mdl.dataset.actualKey = actualModelKey;
          }
          
          if (yearData) {
            // Use year ranges from the detailed database
            Object.keys(yearData)
              .sort(function(a, b) {
                var startA = parseInt(a.split('-')[0], 10);
                var startB = parseInt(b.split('-')[0], 10);
                return startB - startA;
              })
              .forEach(function(range) {
              var opt = document.createElement('option');
              opt.value = range;
              opt.textContent = range;
              yr.appendChild(opt);
              });
          } else {
            // Fall back to standard year ranges
            YEAR_RANGES.forEach(function(range) {
              var opt = document.createElement('option');
              opt.value = range;
              opt.textContent = range;
              yr.appendChild(opt);
            });
          }
        }
        checkReady();
      };

      yr.onchange = function() {
        eng.innerHTML = '<option value="">Select Engine</option>';
        eng.disabled = !yr.value;

        if (yr.value) {
          var mfrKey = mfr.value;
          var mdlKey = mdl.dataset.actualKey || mdl.value;
          var yearData = DB.yearEngines[mfrKey] && DB.yearEngines[mfrKey][mdlKey];
          var engines = null;

          // Get year-specific engines (now includes CSV engines via smart merge)
          if (yearData && yearData[yr.value]) {
            engines = yearData[yr.value];
          }

          if (!engines || engines.length === 0) {
            var unverifiedOpt = document.createElement('option');
            unverifiedOpt.value = '';
            unverifiedOpt.textContent = 'No engines available for selected year/model';
            eng.appendChild(unverifiedOpt);
            eng.disabled = true;
            checkReady();
            return;
          }

          // Deduplicate and display
          Array.from(new Set(engines)).forEach(function(e) {
            var opt = document.createElement('option');
            opt.value = e;
            opt.textContent = e;
            eng.appendChild(opt);
          });
        }
        checkReady();
      };

      eng.onchange = checkReady;

      searchBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!mfr.value || !mdl.value || !yr.value || !eng.value) return;
        showResults();
      };

      backBtn.onclick = function() {
        searchForm.style.display = 'block';
        resultsView.classList.remove('show');
      };

      function showResults() {
        var mfrName = mfr.options[mfr.selectedIndex].textContent;
        var mdlName = mdl.options[mdl.selectedIndex].textContent;
        var yearRange = yr.value;
        var engineStr = eng.value;

        // Parse engine info
        var hpMatch = engineStr.match(/(\d+)\s*hp/i);
        var stockHP = hpMatch ? parseInt(hpMatch[1]) : 150;
        
        // Determine if diesel
        var isDiesel = /tdi|cdi|hdi|dci|jtd|d-4d|crdi|bluehdi|skyactiv-d|diesel|multijet/i.test(engineStr);
        var fuelType = isDiesel ? 'Diesel' : 'Petrol';

        // Calculate stage power (diesel gets more gains)
        var s1Power = Math.round(stockHP * (isDiesel ? 1.25 : 1.20));
        var s2Power = Math.round(stockHP * (isDiesel ? 1.40 : 1.35));
        var s3Power = Math.round(stockHP * (isDiesel ? 1.55 : 1.50));

        // Estimate torque (diesel ~2x, petrol ~1.5x of HP)
        var stockTorque = Math.round(stockHP * (isDiesel ? 2.2 : 1.1));
        var s1Torque = Math.round(stockTorque * (isDiesel ? 1.30 : 1.20));
        var s2Torque = Math.round(stockTorque * (isDiesel ? 1.45 : 1.35));
        var s3Torque = Math.round(stockTorque * (isDiesel ? 1.60 : 1.50));

        // Update title
        document.getElementById('vehicleTitle').textContent = mfrName + ' ' + mdlName + ' (' + yearRange + ')';
        document.getElementById('engineBadge').innerHTML = 
          '<strong>' + engineStr + '</strong> ‚Ä¢ ' + fuelType + ' ‚Ä¢ Turbocharged';

        // Build stages
        var html = '';
        
        // Stage 1
        html += buildStageCard('Stage 1', 'ECU Remap Only', stockHP, s1Power, stockTorque, s1Torque);
        
        // Stage 2
        html += buildStageCard('Stage 2', 'Remap + Intake/Exhaust', stockHP, s2Power, stockTorque, s2Torque);
        
        // Stage 3
        html += buildStageCard('Stage 3', 'Full Build + Hybrid Turbo', stockHP, s3Power, stockTorque, s3Torque);

        document.getElementById('stagesContainer').innerHTML = html;
        // Hide all stage cards if showStages param is 0
        if (_showStages === '0') {
          var stageCards = document.querySelectorAll('.stage-card');
          stageCards.forEach(function(card) {
            card.style.display = 'none';
          });
        }

        // Set up quote buttons
        var quoteMsg = encodeURIComponent(
          'Hi! I\'m interested in ECU tuning for my ' + mfrName + ' ' + mdlName + 
          ' (' + yearRange + ') with ' + engineStr + '. Can you provide a quote?'
        );
        
        // Use overrides passed via data attributes (from URL params) if present
        var waBtn = document.getElementById('whatsappBtn');
        var emBtn = document.getElementById('emailBtn');
        var sBtn = document.getElementById('smsBtn');
        var waOverride = waBtn?.dataset?.override || '';
        var emailOverride = emBtn?.dataset?.override || '';
        var defaultPhone = '447546371963';
        var defaultEmail = 'carnageremaps@gmail.com';

        var targetPhone = waOverride || defaultPhone;
        // whatsapp link
        if (waBtn) waBtn.href = 'https://wa.me/' + targetPhone + '?text=' + quoteMsg;
        // email link
        if (emBtn) emBtn.href = 'mailto:' + (emailOverride || defaultEmail) + '?subject=' + encodeURIComponent('Quote Request: ' + mfrName + ' ' + mdlName) + '&body=' + quoteMsg;
        // sms link (ensure leading + when using sms: on some platforms)
        if (sBtn) sBtn.href = 'sms:+' + (targetPhone) + '?body=' + quoteMsg;

        // Toggle views
        searchForm.style.display = 'none';
        resultsView.classList.add('show');
      }

      function buildStageCard(name, method, stockHP, tunedHP, stockTq, tunedTq) {
        var hpGain = tunedHP - stockHP;
        var tqGain = tunedTq - stockTq;
        
        return '<div class="stage-card">' +
          '<div class="stage-header">' +
            '<span class="stage-name">' + name + '</span>' +
            '<span class="stage-method">' + method + '</span>' +
          '</div>' +
          '<div class="perf-grid">' +
            '<div class="perf-box">' +
              '<div class="perf-label">POWER</div>' +
              '<div class="perf-row">' +
                '<span class="stock">' + stockHP + '</span>' +
                '<span class="arrow">‚Üí</span>' +
                '<span class="tuned">' + tunedHP + ' HP</span>' +
              '</div>' +
              '<div class="gain">+' + hpGain + ' HP (+' + Math.round(hpGain/stockHP*100) + '%)</div>' +
            '</div>' +
            '<div class="perf-box">' +
              '<div class="perf-label">TORQUE</div>' +
              '<div class="perf-row">' +
                '<span class="stock">' + stockTq + '</span>' +
                '<span class="arrow">‚Üí</span>' +
                '<span class="tuned">' + tunedTq + ' Nm</span>' +
              '</div>' +
              '<div class="gain">+' + tqGain + ' Nm (+' + Math.round(tqGain/stockTq*100) + '%)</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }
    })();
  </script>

  <!-- Subscription Check Script -->
  <script>
    (async function() {
      try {
        // Extract URL parameters for tracking
        const urlParams = new URLSearchParams(window.location.search);
        const iframeId = urlParams.get('iframeId');
        const emailParam = urlParams.get('email');
        
        // Store for potential future use
        window.iframeId = iframeId;
        window.userEmail = emailParam;
        
        // Service access is now handled by backend APIs
        // No frontend subscription checks needed
        
        // Hide loading overlays
        const overlay = document.getElementById('subscription-check');
        if (overlay) overlay.style.display = 'none';
        
      } catch (error) {
        console.log('Initialization error (embed):', error);
        // On error, show widget anyway
        const overlay = document.getElementById('subscription-check');
        if (overlay) overlay.style.display = 'none';
      }
    })();
  </script>

  <script>
    // Track iframe usage and check lock status when the embed loads
    (async function() {
      try {
        const params = new URLSearchParams(window.location.search);
        const iframeId = params.get('iframeId');
        const emailParam = params.get('email');
        
        // Store for potential use
        window.userEmail = emailParam;
        window.iframeId = iframeId;
        
        // Check iframe lock status
        let locked = false;
        
        if (iframeId) {
          try {
            const statusResp = await fetch(`/api/iframes/${iframeId}/status`, { cache: 'no-store' });
            const statusData = statusResp.ok ? await statusResp.json() : null;
            locked = statusData?.iframe?.status === 'locked' || statusData?.iframe?.locked === true;
            console.log('Embed lock status (by ID):', { iframeId, locked, status: statusData?.iframe?.status });
          } catch (err) {
            console.warn('Iframe status check failed', err);
          }
        } else if (emailParam) {
          try {
            const statusResp = await fetch(`/api/iframes/status-by-email?email=${encodeURIComponent(emailParam)}&type=embed`, { cache: 'no-store' });
            const statusData = statusResp.ok ? await statusResp.json() : null;
            locked = statusData?.iframe?.status === 'locked' || statusData?.iframe?.locked === true;
            console.log('Embed lock status (by email):', { emailParam, locked, status: statusData?.iframe?.status });
          } catch (err) {
            console.warn('Iframe email status check failed', err);
          }
        }
        
        // If locked, show overlay and hide widget persistently
        if (locked) {
          const overlay = document.getElementById('iframe-locked');
          const widget = document.getElementById('widget');
          if (overlay) {
            overlay.classList.add('show');
          }
          if (widget) {
            widget.style.display = 'none';
          }
          console.log('iframe-locked overlay displayed');
          return; // Exit early - don't track usage or continue
        }
        
        // If not locked, ensure overlay stays hidden
        const overlay = document.getElementById('iframe-locked');
        if (overlay) {
          overlay.classList.remove('show');
        }
        
        // Track iframe usage if iframeId present
        if (iframeId) {
          fetch(`/api/iframes/${iframeId}/track`, { method: 'POST' }).catch(() => {});
        }
        
      } catch (err) {
        console.log('Embed initialization error:', err.message);
      }
    })();
  </script>
</body>
</html>
